<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§é˜ªä¸ƒæ—¥è¡Œ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --bg: #f4f6f8; }
        body { margin: 0; display: flex; height: 100vh; font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); flex-direction: column; }
        
        header { background: var(--primary); color: white; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 20; }
        .h-title { font-weight: bold; font-size: 1.2rem; }
        .h-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
        .h-btn:hover { background: rgba(255,255,255,0.3); }
        .h-btn.active { background: #e67e22; border-color: #e67e22; }

        .day-bar { background: white; padding: 10px; overflow-x: auto; white-space: nowrap; border-bottom: 1px solid #ddd; flex-shrink: 0; display: flex; gap: 10px; z-index: 15; }
        .day-btn { border: 1px solid #e0e0e0; background: #fff; padding: 8px 18px; border-radius: 25px; font-size: 0.9rem; color: #555; cursor: pointer; transition: 0.2s; }
        .day-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }

        .container { display: flex; flex: 1; overflow: hidden; position: relative; flex-direction: column-reverse; }
        #map { flex: 1; z-index: 1; background: #e5e9ec; }
        #panel { height: 45%; background: white; overflow-y: auto; box-shadow: 0 -5px 20px rgba(0,0,0,0.15); z-index: 2; display: flex; flex-direction: column; }
        
        @media (min-width: 768px) {
            .container { flex-direction: row; }
            #map { height: 100%; width: auto; flex-grow: 1; }
            #panel { height: 100%; width: 420px; min-width: 420px; border-right: 1px solid #ccc; }
        }

        .day-header { padding: 20px; background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 10; }
        .dh-title { font-size: 1.4rem; font-weight: bold; color: var(--primary); }
        
        .card-container { display: flex; gap: 12px; margin-bottom: 25px; padding: 0 15px; }
        .meta-col { width: 45px; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
        .meta-time { font-size: 0.75rem; font-weight: bold; color: #999; margin-bottom: 6px; }
        .meta-icon { width: 30px; height: 30px; border-radius: 50%; background: #eee; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; font-size: 14px; z-index: 2; }
        .meta-line { width: 2px; background: #e0e0e0; flex-grow: 1; margin-top: 5px; margin-bottom: -30px; }
        .card-container:last-child .meta-line { display: none; }

        .type-food .meta-icon { background: #ff6b6b; color: white; }
        .type-sight .meta-icon { background: #51cf66; color: white; }
        .type-shop .meta-icon { background: #339af0; color: white; }
        .type-stay .meta-icon { background: #845ef7; color: white; }
        .type-move .meta-icon { background: #34495e; color: white; width: 24px; height: 24px; font-size: 12px; }
        .type-supply .meta-icon { background: #00b894; color: white; } /* è£œçµ¦ç«™é¡è‰² */

        .content-col { flex-grow: 1; }
        .card { background: white; border: 1px solid #eee; border-radius: 12px; padding: 15px; transition: all 0.2s; cursor: pointer; }
        .card:hover { border-color: #bdc3c7; transform: translateY(-2px); }
        .card.active-card { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(230, 126, 34, 0.2); background: #fffdf9; }
        .card.move { background: #fdfdfe; border: 1px dashed #b0bec5; padding: 10px 15px; }

        .tr-title, .c-title { font-weight: bold; color: #2c3e50; font-size: 1rem; margin-bottom: 5px; }
        .tr-dest, .c-desc { font-size: 0.9rem; color: #666; }
        .tr-badges { margin-bottom: 5px; }
        .tr-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 5px; }
        .badge-time { background: #e3f2fd; color: #1565c0; }
        .badge-price { background: #fff3e0; color: #e67e22; }
        .badge-dist { background: #e8f5e9; color: #2e7d32; }

        .opt-group { margin-top: 12px; background: #f8f9fa; border-radius: 8px; padding: 8px; border: 1px solid #f1f1f1; }
        .opt-btn { display: flex; align-items: center; padding: 8px; border-radius: 6px; cursor: pointer; margin-bottom: 4px; }
        .opt-btn:hover { background: #e9ecef; }
        .opt-btn.selected { background: #fff; border: 1px solid #3498db; box-shadow: 0 2px 5px rgba(52, 152, 219, 0.2); }
        .opt-radio { width: 12px; height: 12px; border-radius: 50%; border: 2px solid #ccc; margin-right: 10px; background: white; }
        .opt-btn.selected .opt-radio { border-color: #3498db; background: #3498db; }

        .map-label { background: rgba(255, 255, 255, 0.95); border: 1px solid #2c3e50; padding: 2px 6px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-size: 12px; color: #2c3e50; font-weight: bold; }
        
        .legend { position: absolute; bottom: 20px; left: 20px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 0.85rem; z-index: 1000; }
        .l-item { display: flex; align-items: center; margin-bottom: 4px; }
        .l-line { width: 30px; height: 4px; margin-right: 8px; border-radius: 2px; }

        .popup-btn { background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-top: 5px; width: 100%; }
        .popup-btn:hover { background: #2ecc71; }
    </style>
</head>
<body>

<header>
    <div class="h-title">ğŸ‡¯ğŸ‡µ å¤§é˜ªä¸ƒæ—¥è¡Œ</div>
    <button class="h-btn active" id="toggleSupplyBtn" onclick="toggleSupplies()">ğŸª é¡¯ç¤ºè£œçµ¦ç«™</button>
</header>

<div class="day-bar" id="dayBar"></div>

<div class="container">
    <div id="map">
        <div class="legend">
            <div class="l-item"><div class="l-line" style="background:#2c3e50; height:3px;"></div>é›»è»Šè»Œé“</div>
            <div class="l-item"><div class="l-line" style="background:#3498db; border-bottom: 2px dashed #3498db;"></div>æ­¥è¡Œ</div>
            <div class="l-item"><div style="width:20px;height:20px;background:#00b894;border-radius:50%;margin-right:8px;border:2px solid white;text-align:center;color:white;font-size:12px;line-height:16px;">ğŸª</div>è£œçµ¦ç«™ (é»æ“ŠåŠ å…¥)</div>
        </div>
    </div>
    <div id="panel"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. åœ°é»è³‡æ–™åº«
    const pts = {
        hotel: { lat: 34.654034, lng: 135.507531, name: "ä½å®¿é»", hours: "Check-in" },
        kix: { lat: 34.4338, lng: 135.2330, name: "é—œè¥¿æ©Ÿå ´ (KIX)" },
        rinku_town: { lat: 34.4097, lng: 135.2985, name: "è‡¨ç©ºåŸç«™" },
        stn_shinimamiya: { lat: 34.6500, lng: 135.5005, name: "æ–°ä»Šå®®ç«™" }, 
        stn_ebisucho: { lat: 34.6548, lng: 135.5055, name: "æƒ ç¾é ˆç”ºç«™" },
        stn_nippombashi: { lat: 34.6672, lng: 135.5067, name: "æ—¥æœ¬æ©‹ç«™" },
        stn_namba_subway: { lat: 34.6655, lng: 135.5015, name: "é›£æ³¢ç«™ (åœ°éµ)" },
        stn_umeda: { lat: 34.7042, lng: 135.4972, name: "æ¢…ç”°ç«™" },
        stn_kiyomizu: { lat: 34.9959, lng: 135.7665, name: "æ¸…æ°´äº”æ¢ç«™" },
        stn_gion: { lat: 35.0038, lng: 135.7720, name: "ç¥‡åœ’å››æ¢ç«™" },
        stn_fushimi: { lat: 34.9672, lng: 135.7709, name: "ä¼è¦‹ç¨»è·ç«™" },
        stn_nara: { lat: 34.6835, lng: 135.8273, name: "è¿‘éµå¥ˆè‰¯ç«™" },
        stn_tanimachi4: { lat: 34.6830, lng: 135.5173, name: "è°·ç”ºå››ä¸ç›®ç«™" },
        
        sukiya: { lat: 34.6543, lng: 135.5049, name: "Sukiya æƒ ç¾é ˆç”ºåº—", hours: "24H" },
        matsuya: { lat: 34.6660, lng: 135.5020, name: "æ¾å±‹", hours: "24H" },
        komeda_namba: { lat: 34.6644, lng: 135.5027, name: "Komeda å’–å•¡", hours: "07:00-23:00" },
        mister_donut: { lat: 34.6520, lng: 135.5060, name: "Mister Donut é€šå¤©é–£", hours: "09:00-21:00" },
        kizu: { lat: 34.6565, lng: 135.4981, name: "æœ¨æ´¥å¸‚å ´", hours: "06:00-12:00" },
        hanamaruken: { lat: 34.6675, lng: 135.5026, name: "èŠ±ä¸¸è»’", hours: "24H" },
        kamukura: { lat: 34.6680, lng: 135.5015, name: "ç¥åº§æ‹‰éºµ", hours: "10:00-07:00" },
        otako: { lat: 34.6685, lng: 135.5028, name: "æœ¬å®¶å¤§ãŸã“", hours: "10:00-23:00" },
        wanaka: { lat: 34.6663, lng: 135.5035, name: "Wanaka ç« é­šç‡’", hours: "10:00-22:00" },
        ajinoya: { lat: 34.6688, lng: 135.5010, name: "å‘³ä¹ƒå®¶", hours: "11:00-22:00" },
        mizuno: { lat: 34.6685, lng: 135.5015, name: "ç¾æ´¥ã®", hours: "11:00-22:00" },
        mugen: { lat: 34.6650, lng: 135.5032, name: "MUGEN æ¼¢å ¡æ’", hours: "11:30-15/17-22" },
        bikkuri: { lat: 34.6688, lng: 135.4994, name: "Bikkuri Donkey", hours: "08:00-Late" },
        rikimaru: { lat: 34.6693, lng: 135.5014, name: "ç‡’è‚‰åŠ›ä¸¸", hours: "16:00-23:15" },
        aburiya: { lat: 34.6655, lng: 135.5020, name: "åœ‹ç”¢ç‰›ç‡’è‚‰", hours: "17:00-23:00" },
        motomura: { lat: 34.6660, lng: 135.5015, name: "ç‚¸ç‰›æ’ Motomura", hours: "11:00-22:00" },
        katsugyu: { lat: 34.6658, lng: 135.5012, name: "äº¬éƒ½å‹ç‰›", hours: "11:00-22:00" },
        daruma: { lat: 34.6517, lng: 135.5064, name: "é”æ‘©ä¸²ç‚¸ æœ¬åº—", hours: "11:00-22:30" },
        yaekatsu: { lat: 34.6520, lng: 135.5060, name: "å…«é‡å‹ä¸²ç‚¸", hours: "10:30-21:00" },
        botani: { lat: 34.6865, lng: 135.5002, name: "BOTANI:CURRY", hours: "11-15:30" },
        camp_curry: { lat: 34.7030, lng: 135.4970, name: "Camp Curry", hours: "11:00-22:00" },
        spoon: { lat: 34.6750, lng: 135.5000, name: "Curry Spoon", hours: "11:30-15/17-21" },
        coco: { lat: 34.6745, lng: 135.5010, name: "CoCoå£¹ç•ªå±‹", hours: "11:00-23:00" },

        nara_park: { lat: 34.6850, lng: 135.8430, name: "å¥ˆè‰¯å…¬åœ’" },
        kiyomizu_temple: { lat: 34.9948, lng: 135.7850, name: "æ¸…æ°´å¯º æœ¬å ‚" },
        fushimi_shrine: { lat: 34.9671, lng: 135.7726, name: "ä¼è¦‹ç¨»è·å¤§ç¤¾" },
        osaka_castle: { lat: 34.6873, lng: 135.5262, name: "å¤§é˜ªåŸ å¤©å®ˆé–£" },
        denden: { lat: 34.6593, lng: 135.5060, name: "Den Den Town" },
        rinku_outlet: { lat: 34.4079, lng: 135.2952, name: "è‡¨ç©ºåŸ Outlet" },
        yodobashi: { lat: 34.7042, lng: 135.4965, name: "Yodobashi" },
        ginza_karen: { lat: 34.6740, lng: 135.5010, name: "éŠ€åº§Karen" },
        amemura: { lat: 34.6720, lng: 135.4990, name: "ç¾åœ‹æ‘" }
    };

    // è£œçµ¦ç«™è³‡æ–™ (ä¾¿åˆ©å•†åº— - æ›´æ–°ç‰ˆ)
    const supplies = [
        // --- é£¯åº—å‘¨é‚Š (å¯†é›†è£œå®Œ) ---
        { lat: 34.6551, lng: 135.5054, brand: 'seven', name: "7-Eleven å¤§é˜ªæƒ ç¾é ˆè¥¿1ä¸ç›®" }, // ä½ æŒ‡å®šçš„åº—ï¼
        { lat: 34.6533, lng: 135.5063, brand: 'lawson', name: "Lawson é€šå¤©é–£æœ¬é€šåº—" }, // é£¯åº—åŒ—å´å··å­
        { lat: 34.6544, lng: 135.5048, brand: 'family', name: "FamilyMart æƒ ç¾é ˆè¥¿2ä¸ç›®" }, // é£¯åº—è¥¿åŒ—å´
        { lat: 34.6535, lng: 135.5049, brand: 'lawson', name: "Lawson æµªé€Ÿæƒ ç¾é ˆè¥¿2ä¸ç›®" }, // é£¯åº—è¥¿å´
        { lat: 34.6558, lng: 135.5052, brand: 'seven', name: "7-Eleven å¤§é˜ªæ—¥æœ¬æ©‹5ä¸ç›®" }, // åœ°éµç«™åŒ—é‚Š
        
        // --- å…¶ä»–æ™¯é»å‘¨é‚Š ---
        { lat: 34.6655, lng: 135.5010, brand: 'lawson', name: "Lawson é›£æ³¢ä¸­2ä¸ç›®" }, 
        { lat: 34.6890, lng: 135.5330, brand: 'lawson', name: "Lawson æ£®ä¹‹å®® (å¤§é˜ªåŸ)" }, 
        { lat: 35.0035, lng: 135.7780, brand: 'lawson', name: "Lawson å…«å‚ç¥ç¤¾å‰" }, 
        { lat: 34.9960, lng: 135.7680, brand: 'family', name: "FamilyMart äº¬é˜ªäº”æ¢" }, 
        { lat: 34.9670, lng: 135.7705, brand: 'seven', name: "7-Eleven ä¼è¦‹ç¨»è·ç«™å‰" }, 
        { lat: 34.6830, lng: 135.8280, brand: 'seven', name: "7-Eleven è¿‘éµå¥ˆè‰¯ç«™" }, 
        { lat: 34.4095, lng: 135.2980, brand: 'family', name: "FamilyMart è‡¨ç©ºåŸç«™" } 
    ];

    const trainPaths = {
        nankai_in: [[34.4338, 135.2330], [34.4390, 135.2440], [34.4350, 135.2530], [34.4285, 135.2635], [34.4220, 135.2760], [34.4170, 135.2860], [34.4130, 135.2930], [34.4097, 135.2985]], 
        nankai_city: [[34.4097, 135.2985], [34.4140, 135.3050], [34.4250, 135.3200], [34.4440, 135.3520], [34.5200, 135.4400], [34.5320, 135.4520], [34.5500, 135.4650], [34.5830, 135.4850], [34.6200, 135.4930], [34.6350, 135.4980], [34.6500, 135.5005]],
        nankai_out: [[34.6500, 135.5005], [34.6350, 135.4980], [34.6200, 135.4930], [34.5830, 135.4850], [34.5320, 135.4520], [34.4440, 135.3520], [34.4170, 135.2860], [34.4338, 135.2330]],
        sakaisuji_short: [[34.6548, 135.5055], [34.6590, 135.5062], [34.6672, 135.5067]],
        keihan: [[34.6914, 135.5064], [34.6900, 135.5150], [34.6980, 135.5330], [34.7200, 135.5600], [34.8000, 135.6300], [34.8600, 135.6800], [34.9300, 135.7500], [34.9500, 135.7650], [34.9670, 135.7709], [34.9800, 135.7680], [34.9880, 135.7660], [34.9959, 135.7665]],
        keihan_ret: [[34.9672, 135.7709], [34.9500, 135.7650], [34.9300, 135.7500], [34.8600, 135.6800], [34.6980, 135.5330], [34.6914, 135.5064], [34.6672, 135.5067]],
        kintetsu: [[34.6672, 135.5067], [34.6665, 135.5140], [34.6655, 135.5290], [34.6630, 135.5600], [34.6640, 135.5800], [34.6800, 135.6500], [34.6850, 135.6800], [34.6930, 135.7000], [34.6940, 135.7800], [34.6835, 135.8273]],
        midosuji: [[34.6655, 135.5015], [34.6710, 135.5005], [34.6820, 135.5000], [34.6950, 135.4980], [34.7042, 135.4972]],
        chuo: [[34.6548, 135.5055], [34.6820, 135.5070], [34.6820, 135.5173]]
    };

    const days = [
        {
            day: "Day 1", date: "1/27", title: "æŠµé” & è‡¨ç©ºåŸ",
            items: [
                { type: "info", time: "10:40", title: "æŠµé”é—œè¥¿æ©Ÿå ´", desc: "å…¥å¢ƒå¾Œä¸Š2F" },
                { type: "move", mode: "train", name: "å—æµ·é›»éµ", desc: "æ©Ÿå ´â†’è‡¨ç©ºåŸ", path: trainPaths.nankai_in, from: pts.kix, to: pts.rinku_town, price: "370", time: "6åˆ†" },
                { type: "shop", time: "12:00", title: "è‡¨ç©ºåŸ Outlet", loc: pts.rinku_outlet, desc: "Seaside Area" },
                { type: "move", mode: "train", name: "å—æµ·é›»éµ", desc: "è‡¨ç©ºåŸâ†’æ–°ä»Šå®®", path: trainPaths.nankai_city, from: pts.rinku_town, to: pts.stn_shinimamiya, price: "780", time: "40åˆ†" },
                { type: "move", mode: "walk", name: "æ­¥è¡Œå‰å¾€é£¯åº—", from: pts.stn_shinimamiya, to: pts.hotel, desc: "ç´„10åˆ†é˜" },
                { type: "stay", time: "16:00", title: "é£¯åº— Check-in", loc: pts.hotel },
                { type: "move", title: "å‰å¾€é›£æ³¢", options: [{ name: "åœ°éµ: æƒ ç¾é ˆç”ºâ†’æ—¥æœ¬æ©‹", mode: "train", path: trainPaths.sakaisuji_short, from: pts.stn_ebisucho, to: pts.stn_nippombashi, price: "190", time: "2åˆ†", desc: "è»Šç«™å°±åœ¨æ—é‚Š" }, { name: "èµ°è·¯: ç›´èµ°å ºç­‹", mode: "walk", from: pts.hotel, to: pts.stn_nippombashi, desc: "ç´„1.2km" }] },
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.stn_nippombashi, to: pts.rikimaru },
                { type: "food", time: "18:30", title: "æ™šé¤", options: [{name: "ç‡’è‚‰åŠ›ä¸¸", loc: pts.rikimaru}, {name: "åœ‹ç”¢ç‰›ç‡’è‚‰", loc: pts.aburiya, backup:true}] },
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.rikimaru, to: pts.otako },
                { type: "food", time: "20:30", title: "é»å¿ƒ", options: [{name: "æœ¬å®¶å¤§ãŸã“", loc: pts.otako}, {name: "Wanaka ç« é­šç‡’", loc: pts.wanaka, backup:true}] },
                { type: "move", title: "å›é£¯åº—", options: [{ name: "åœ°éµ: é›£æ³¢â†’æƒ ç¾é ˆç”º", mode: "train", path: trainPaths.sakaisuji_short, from: pts.stn_namba_subway, to: pts.stn_ebisucho, price: "190", time: "2åˆ†" }, { name: "èµ°è·¯: é£¯å¾Œæ•£æ­¥", mode: "walk", from: pts.stn_namba_subway, to: pts.hotel }] }
            ]
        },
        {
            day: "Day 2", date: "1/28", title: "äº¬éƒ½å·¡ç¦®",
            items: [
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.hotel, to: pts.sukiya },
                { type: "food", time: "08:30", title: "æ—©é¤", options: [{name: "Sukiya", loc: pts.sukiya}, {name: "Mister Donut", loc: pts.mister_donut, backup:true}] },
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.sukiya, to: pts.stn_ebisucho },
                { type: "move", mode: "train", name: "å ºç­‹ç·š+äº¬é˜ª", desc: "å‰å¾€æ¸…æ°´äº”æ¢", path: trainPaths.keihan, from: pts.stn_ebisucho, to: pts.stn_kiyomizu, price: "650", time: "65åˆ†" },
                { type: "move", mode: "walk", name: "æ­¥è¡Œä¸Šå±±", desc: "ç¶“äºŒä¸‰å¹´å‚", from: pts.stn_kiyomizu, to: pts.kiyomizu_temple },
                { type: "sight", time: "10:30", title: "æ¸…æ°´å¯º", loc: pts.kiyomizu_temple },
                { type: "move", mode: "walk", name: "æ­¥è¡Œä¸‹å±±", from: pts.kiyomizu_temple, to: pts.stn_gion },
                { type: "move", mode: "train", name: "äº¬é˜ª", desc: "ç¥‡åœ’â†’ä¼è¦‹", from: pts.stn_gion, to: pts.stn_fushimi, price: "220", time: "10åˆ†" },
                { type: "sight", time: "15:00", title: "ä¼è¦‹ç¨»è·", loc: pts.fushimi_shrine },
                { type: "move", mode: "train", name: "äº¬é˜ª+å ºç­‹", desc: "å›å¤§é˜ª", path: trainPaths.keihan_ret, from: pts.stn_fushimi, to: pts.stn_namba_subway, price: "640", time: "50åˆ†" },
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.stn_namba_subway, to: pts.hanamaruken },
                { type: "food", time: "19:00", title: "æ™šé¤", options: [{name: "èŠ±ä¸¸è»’", loc: pts.hanamaruken}, {name: "ç¥åº§æ‹‰éºµ", loc: pts.kamukura, backup:true}] },
                { type: "move", mode: "walk", name: "æ­¥è¡Œå›é£¯åº—", from: pts.hanamaruken, to: pts.hotel }
            ]
        },
        {
            day: "Day 3", date: "1/29", title: "å¥ˆè‰¯ & é›»å­è¡—",
            items: [
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.hotel, to: pts.stn_ebisucho },
                { type: "move", mode: "train", name: "åœ°éµ", desc: "å‰å¾€é›£æ³¢", from: pts.stn_ebisucho, to: pts.stn_namba_subway, price: "190", time: "2åˆ†" },
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.stn_namba_subway, to: pts.komeda_namba },
                { type: "food", time: "09:00", title: "æ—©é¤", options: [{name: "Komeda å’–å•¡", loc: pts.komeda_namba}, {name: "æ¾å±‹", loc: pts.matsuya, backup:true}] },
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.komeda_namba, to: pts.stn_nippombashi },
                { type: "move", mode: "train", name: "è¿‘éµ", desc: "å‰å¾€å¥ˆè‰¯", path: trainPaths.kintetsu, from: pts.stn_nippombashi, to: pts.stn_nara, price: "680", time: "45åˆ†" },
                { type: "sight", time: "10:30", title: "å¥ˆè‰¯å…¬åœ’", loc: pts.nara_park },
                { type: "move", mode: "train", name: "è¿‘éµ", desc: "å›æ—¥æœ¬æ©‹", path: trainPaths.kintetsu, from: pts.stn_nara, to: pts.stn_nippombashi, price: "680", time: "45åˆ†" },
                { type: "shop", time: "15:30", title: "é›»å­è¡—", loc: pts.denden },
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.denden, to: pts.mugen },
                { type: "food", time: "19:00", title: "æ™šé¤", options: [{name: "MUGEN", loc: pts.mugen}, {name: "Bikkuri Donkey", loc: pts.bikkuri, backup:true}] },
                { type: "move", mode: "walk", name: "æ­¥è¡Œå›é£¯åº—", from: pts.mugen, to: pts.hotel }
            ]
        },
        {
            day: "Day 4", date: "1/30", title: "æ¢…ç”° & è›‹ç³•",
            items: [
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.hotel, to: pts.stn_ebisucho },
                { type: "move", mode: "train", name: "å¾¡å ‚ç­‹ç·š", desc: "å‰å¾€æ¢…ç”°", path: trainPaths.midosuji, from: pts.stn_ebisucho, to: pts.stn_umeda, price: "240", time: "15åˆ†" },
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.stn_umeda, to: pts.botani },
                { type: "food", time: "10:30", title: "åˆé¤", options: [{name: "BOTANI å’–å“©", loc: pts.botani}, {name: "Camp Curry", loc: pts.camp_curry, backup:true}] },
                { type: "shop", time: "13:00", title: "Yodobashi", loc: pts.yodobashi },
                { type: "move", mode: "train", name: "å¾¡å ‚ç­‹ç·š", desc: "å›é›£æ³¢", path: trainPaths.midosuji, from: pts.stn_umeda, to: pts.stn_namba_subway, price: "240", time: "15åˆ†" },
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.stn_namba_subway, to: pts.ajinoya },
                { type: "food", time: "19:00", title: "æ™šé¤", options: [{name: "å‘³ä¹ƒå®¶", loc: pts.ajinoya}, {name: "ç¾æ´¥ã®", loc: pts.mizuno, backup:true}] },
                { type: "move", mode: "walk", name: "æ­¥è¡Œå›é£¯åº—", from: pts.ajinoya, to: pts.hotel }
            ]
        },
        {
            day: "Day 5", date: "1/31", title: "å¸‚å ´ & å¤§é˜ªåŸ",
            items: [
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.hotel, to: pts.kizu },
                { type: "food", time: "09:00", title: "æ—©é¤", options: [{name: "æœ¨æ´¥å¸‚å ´", loc: pts.kizu}, {name: "Sukiya", loc: pts.sukiya, backup:true}] },
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.kizu, to: pts.stn_ebisucho },
                { type: "move", mode: "train", name: "åœ°éµ", desc: "å‰å¾€å¤§é˜ªåŸ", path: trainPaths.chuo, from: pts.stn_ebisucho, to: pts.stn_tanimachi4, price: "240", time: "20åˆ†" },
                { type: "sight", time: "11:00", title: "å¤§é˜ªåŸ", loc: pts.osaka_castle },
                { type: "move", mode: "train", name: "åœ°éµ", desc: "å›é›£æ³¢", from: pts.stn_tanimachi4, to: pts.stn_namba_subway, price: "240", time: "20åˆ†" },
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.stn_namba_subway, to: pts.motomura },
                { type: "food", time: "18:00", title: "æ™šé¤", options: [{name: "ç‚¸ç‰›æ’ Motomura", loc: pts.motomura}, {name: "äº¬éƒ½å‹ç‰›", loc: pts.katsugyu, backup:true}] },
                { type: "food", time: "20:00", title: "å®µå¤œ", options: [{name: "é”æ‘©ä¸²ç‚¸", loc: pts.daruma}, {name: "å…«é‡å‹", loc: pts.yaekatsu, backup:true}] },
                { type: "move", mode: "walk", name: "æ­¥è¡Œå›é£¯åº—", from: pts.daruma, to: pts.hotel }
            ]
        },
        {
            day: "Day 6", date: "2/1", title: "æœ€å¾Œè¡åˆº",
            items: [
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.hotel, to: pts.mister_donut },
                { type: "food", time: "09:00", title: "æ—©é¤", options: [{name: "Mister Donut", loc: pts.mister_donut}, {name: "Sukiya", loc: pts.sukiya, backup:true}] },
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.mister_donut, to: pts.spoon },
                { type: "food", time: "11:30", title: "åˆé¤", options: [{name: "Spoon å’–å“©", loc: pts.spoon}, {name: "CoCoå£¹ç•ªå±‹", loc: pts.coco, backup:true}] },
                { type: "shop", time: "13:30", title: "è²·è¡Œæç®±", loc: pts.ginza_karen },
                { type: "shop", time: "14:30", title: "ç¾åœ‹æ‘", loc: pts.amemura },
                { type: "food", time: "18:00", title: "æ™šé¤", options: [{name: "é”æ‘©ä¸²ç‚¸", loc: pts.daruma}, {name: "å…«é‡å‹", loc: pts.yaekatsu, backup:true}] },
                { type: "move", mode: "walk", name: "æ­¥è¡Œå›é£¯åº—", from: pts.daruma, to: pts.hotel }
            ]
        },
        {
            day: "Day 7", date: "2/2", title: "è¿”ç¨‹",
            items: [
                { type: "stay", time: "08:00", title: "é€€æˆ¿", loc: pts.hotel },
                { type: "move", mode: "walk", name: "æ­¥è¡Œ", from: pts.hotel, to: pts.stn_shinimamiya },
                { type: "move", mode: "train", name: "å—æµ·é›»éµ", desc: "å‰å¾€æ©Ÿå ´", path: trainPaths.nankai_out, from: pts.stn_shinimamiya, to: pts.kix, price: "970", time: "45åˆ†" },
                { type: "info", time: "11:55", title: "é£›æ©Ÿèµ·é£›" }
            ]
        }
    ];

    const map = L.map('map').setView([34.669, 135.501], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);
    let layerGroup = L.layerGroup().addTo(map);
    let supplyLayerGroup = L.layerGroup().addTo(map);
    let highlightLayer = L.layerGroup().addTo(map); 
    let userChoices = {};
    let itemLayers = {}; 
    let currentDayIdx = 0;
    let showSupplies = true;

    // Helper Functions
    function calcDist(p1, p2) {
        if(!p1 || !p2) return 0;
        const R = 6371; 
        const dLat = (p2.lat - p1.lat) * Math.PI / 180;
        const dLon = (p2.lng - p1.lng) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    }
    function formatDist(km) { return km < 1 ? Math.round(km * 1000) + 'm' : km.toFixed(1) + 'km'; }
    function estimateWalk(from, to, manual) {
        if(manual) return { mins: manual, distStr: "é€›è¡—" };
        const dist = calcDist(from, to);
        return { mins: Math.ceil(dist / 0.075) + 2, distStr: formatDist(dist) };
    }
    function getIconColor(t) {
        if(t==='food') return '#ff6b6b'; if(t==='sight') return '#51cf66'; if(t==='shop') return '#339af0'; if(t==='stay') return '#845ef7'; if(t==='supply') return '#00b894';
        return '#34495e';
    }
    function getIconChar(t) {
        if(t==='move') return 'â”'; if(t==='food') return 'ğŸ½ï¸'; if(t==='sight') return 'ğŸ“·'; if(t==='shop') return 'ğŸ›ï¸'; if(t==='stay') return 'ğŸ¨'; if(t==='supply') return 'ğŸª';
        return 'â„¹ï¸';
    }

    // Supply Stations Logic
    function getSupplyColor(brand) {
        if(brand === 'seven') return '#f39c12'; // Orange
        if(brand === 'family') return '#2ecc71'; // Green
        if(brand === 'lawson') return '#3498db'; // Blue
        return '#7f8c8d';
    }

    function renderSupplies() {
        supplyLayerGroup.clearLayers();
        if(!showSupplies) return;

        supplies.forEach((s, idx) => {
            const color = getSupplyColor(s.brand);
            const marker = L.marker([s.lat, s.lng], {
                icon: L.divIcon({
                    className: 'supply-icon',
                    html: `<div style="background:${color};width:24px;height:24px;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);display:flex;justify-content:center;align-items:center;color:white;font-size:14px;">ğŸª</div>`,
                    iconSize: [24, 24], iconAnchor: [12, 12], popupAnchor: [0, -14]
                })
            });
            
            const safeName = s.name.replace(/'/g, "\\'");
            const safeLat = s.lat;
            const safeLng = s.lng;
            
            const popupContent = `
                <div style="font-weight:bold;margin-bottom:4px;">${s.name}</div>
                <div style="font-size:0.8rem;color:#666;">è£œçµ¦ç«™ / ä¾¿åˆ©å•†åº—</div>
                <button class="popup-btn" onclick="addToSchedule('${safeName}', ${safeLat}, ${safeLng})">â• åŠ å…¥è¡Œç¨‹</button>
            `;
            
            marker.bindPopup(popupContent);
            supplyLayerGroup.addLayer(marker);
        });
    }

    function toggleSupplies() {
        showSupplies = !showSupplies;
        const btn = document.getElementById('toggleSupplyBtn');
        if(showSupplies) btn.classList.add('active');
        else btn.classList.remove('active');
        renderSupplies();
    }

    // Add to Schedule Logic
    window.addToSchedule = function(name, lat, lng) {
        const newItem = {
            type: 'supply',
            title: name,
            time: 'å½ˆæ€§',
            desc: 'è£œçµ¦ / ä¼‘æ¯',
            loc: { lat: lat, lng: lng, name: name, hours: '24H' }
        };
        
        days[currentDayIdx].items.push(newItem);
        renderDay(currentDayIdx);
        map.closePopup();
        setTimeout(() => {
            const panel = document.getElementById('panel');
            panel.scrollTop = panel.scrollHeight;
        }, 100);
    }

    // Main Render Logic
    async function drawRoute(from, to, key) {
        if (!from || !to) return;
        try {
            const url = `https://router.project-osrm.org/route/v1/foot/${from.lng},${from.lat};${to.lng},${to.lat}?overview=full&geometries=geojson`;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 1500);
            const res = await fetch(url, { signal: controller.signal });
            clearTimeout(id);
            if(res.ok) {
                const data = await res.json();
                if(data.routes && data.routes.length > 0) {
                    const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    const poly = L.polyline(coords, { color: '#3498db', weight: 4, opacity: 0.8, dashArray: '5, 10' }).addTo(layerGroup);
                    itemLayers[key] = poly; return poly;
                }
            }
        } catch(e) {}
        const poly = L.polyline([[from.lat, from.lng], [to.lat, to.lng]], { color: '#3498db', weight: 4, opacity: 0.6, dashArray: '5, 10' }).addTo(layerGroup);
        itemLayers[key] = poly; return poly;
    }

    function addStationMarker(loc) {
        if(!loc) return;
        L.marker([loc.lat, loc.lng], { 
            icon: L.divIcon({
                className: 'station-icon',
                html: `<div style="background:#34495e;width:24px;height:24px;border-radius:50%;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);display:flex;justify-content:center;align-items:center;color:white;font-size:14px;">ğŸš‰</div>`,
                iconSize: [24, 24], iconAnchor: [12, 12], popupAnchor: [0, -14]
            })
        }).addTo(layerGroup).bindTooltip(loc.name, { permanent: true, direction: 'bottom', offset: [0, 10], className: 'map-label' });
    }

    window.focusItem = function(key, currentLoc, bounds, isPolyline) {
        highlightLayer.clearLayers();
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active-card'));
        const layer = itemLayers[key];
        if(layer) {
            if(isPolyline && layer instanceof L.Polyline) L.polyline(layer.getLatLngs(), { color: 'orange', weight: 8, opacity: 0.7 }).addTo(highlightLayer);
            else L.circleMarker(layer.getLatLng(), { radius: 20, color: 'orange', fill: false, weight: 3 }).addTo(highlightLayer);
        }
        const card = document.getElementById(`card_${key}`);
        if(card) { card.classList.add('active-card'); card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        if(bounds) map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
        else if (currentLoc) map.flyTo([currentLoc.lat, currentLoc.lng], 16);
    }

    async function renderDay(dayIndex) {
        currentDayIdx = dayIndex;
        const day = days[dayIndex];
        const panel = document.getElementById('panel');
        layerGroup.clearLayers();
        highlightLayer.clearLayers();
        itemLayers = {}; 
        const addedStations = new Set();
        let totalCost = 0;
        
        for(let i=0; i<day.items.length; i++) {
            const item = day.items[i];
            const key = `d${dayIndex}_i${i}`;
            const selectedOptIdx = userChoices[key] || 0;
            if(item.options) {
                const opt = item.options[selectedOptIdx];
                if(opt.mode === 'train' && opt.price) totalCost += parseInt(opt.price);
            } else if (item.mode === 'train' && item.price) totalCost += parseInt(item.price);
        }

        let html = `
            <div class="day-header">
                <div style="display:flex;justify-content:space-between;align-items:flex-end;">
                    <div><div class="dh-title">${day.title}</div><div style="color:#666;">ğŸ“… ${day.date}</div></div>
                    ${totalCost > 0 ? `<div style="color:#e67e22;font-weight:bold;">ğŸ’° è»Šè³‡ Â¥${totalCost}</div>` : ''}
                </div>
            </div>
            <div style="padding:15px;">
        `;

        for(let idx=0; idx<day.items.length; idx++) {
            const item = day.items[idx];
            const key = `d${dayIndex}_i${idx}`;
            const selectedOptIdx = userChoices[key] || 0;
            
            let type = item.type;
            let mode = item.mode;
            let title = item.title || item.name;
            let from = item.from;
            let to = item.to;
            let path = item.path;
            let price = item.price;
            let time = item.time;
            let desc = item.desc || "";
            let loc = item.loc; 
            let hours = "";
            let optionsHTML = "";
            
            if(item.options) {
                const opt = item.options[selectedOptIdx];
                mode = opt.mode; title = item.title; 
                if(opt.name) title += ` (${opt.name})`;
                if(opt.from) from = opt.from; if(opt.to) to = opt.to; if(opt.path) path = opt.path;
                if(opt.price) price = opt.price; if(opt.time) time = opt.time; if(opt.desc) desc = opt.desc;
                if(opt.loc) { loc = opt.loc; hours = loc.hours; }
                
                optionsHTML = `<div class="opt-group"><div style="font-size:0.75rem;color:#aaa;font-weight:bold;margin-bottom:6px;">æ–¹æ¡ˆé¸æ“‡</div>`;
                item.options.forEach((o, oIdx) => {
                    let badge = o.mode === 'train' ? "ğŸšˆ é›»è»Š" : (o.mode === 'walk' ? "ğŸš¶ èµ°è·¯" : "å‚™æ¡ˆ");
                    optionsHTML += `
                        <div class="opt-btn ${oIdx===selectedOptIdx?'selected':''}" onclick="selectOpt('${key}', ${oIdx}, ${dayIndex})">
                            <div class="opt-radio"></div>
                            <div style="flex:1">
                                <div style="font-size:0.85rem;font-weight:bold;color:#495057;">${o.name} <span style="font-size:0.7em;color:#e67e22;background:#fff3e0;padding:0 4px;border-radius:4px;">${badge}</span></div>
                                ${o.loc ? `<div style="font-size:0.75rem;color:#999;">${o.loc.hours||''}</div>` : ''}
                                ${o.mode==='train' ? `<div style="font-size:0.75rem;color:#999;">Â¥${o.price} / ${o.time}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                optionsHTML += `</div>`;
            } else if (loc) { hours = loc.hours; if(loc.desc && !desc) desc = loc.desc; }

            let boundsJson = "null", centerJson = "null", isPolyline = false;
            if(type === 'move') {
                isPolyline = true;
                if(mode === 'train') {
                    if(path) {
                        const poly = L.polyline(path, { color: '#2c3e50', weight: 6 }).addTo(layerGroup);
                        L.polyline(path, { color: 'white', weight: 4, dashArray: '10, 10' }).addTo(layerGroup);
                        itemLayers[key] = poly; boundsJson = JSON.stringify(poly.getBounds());
                    }
                    [from, to].forEach(l => { if(l && !addedStations.has(l.name)) { addStationMarker(l); addedStations.add(l.name); } });
                } else {
                    if(from && to) { const poly = await drawRoute(from, to, key); if(poly) boundsJson = JSON.stringify(poly.getBounds()); }
                }
            } else if (loc) {
                const marker = L.marker([loc.lat, loc.lng], { 
                    icon: L.divIcon({
                        className: 'custom-icon',
                        html: `<div style="background:${getIconColor(type)};width:30px;height:30px;border-radius:50%;border:2px solid white;box-shadow:0 3px 6px rgba(0,0,0,0.3);display:flex;justify-content:center;align-items:center;color:white;font-size:16px;">${getIconChar(type)}</div>`,
                        iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -32]
                    })
                }).addTo(layerGroup).bindPopup(`<b>${loc.name}</b><br>${desc}`).bindTooltip(loc.name, { permanent: true, direction: 'bottom', className: 'map-label', offset: [0, 15] });
                itemLayers[key] = marker; centerJson = JSON.stringify(loc);
            }

            const hDisplay = (hours && type!=='move') ? `<div style="margin-top:4px;font-size:0.8rem;color:#e67e22;background:#fff3e0;display:inline-block;padding:2px 6px;border-radius:4px;">ğŸ•’ ${hours}</div>` : "";
            let cardContent = "";
            if(type === 'move') {
                let badgeHTML = "";
                if(mode === 'train') badgeHTML = `${time ? `<span class="tr-badge badge-time">â±ï¸ ${time}</span>` : ''}${price ? `<span class="tr-badge badge-price">ğŸ’° Â¥${price}</span>` : ''}`;
                else { let wInfo = estimateWalk(from, to, item.manualTime || (desc && desc.includes('é€›è¡—') ? 'é€›è¡—' : null)); badgeHTML = `<span class="tr-badge badge-dist">ğŸš¶ ${wInfo.mins}åˆ† (${wInfo.distStr})</span>`; }
                cardContent = `<div class="tr-title">${title}</div><div class="tr-badges">${badgeHTML}</div><div class="tr-dest">${desc}</div>${optionsHTML}`;
            } else {
                cardContent = `<div class="c-title">${title}</div><div class="c-desc">${desc}</div>${hDisplay}${optionsHTML}`;
            }
            
            html += `
                <div class="card-container">
                    <div class="meta-col"><div class="meta-time">${item.time || ''}</div><div class="meta-icon type-${type}">${getIconChar(type)}</div><div class="meta-line"></div></div>
                    <div class="content-col"><div class="card ${type}" id="card_${key}" onclick='focusItem("${key}", ${centerJson}, ${boundsJson}, ${isPolyline})'>${cardContent}</div></div>
                </div>
            `;
        }
        html += `</div>`;
        panel.innerHTML = html;
        renderSupplies(); 
    }

    window.selectOpt = function(key, idx, dIdx) { event.stopPropagation(); userChoices[key] = idx; renderDay(dIdx); }

    const bar = document.getElementById('dayBar');
    days.forEach((d, i) => {
        const btn = document.createElement('button'); btn.className = `day-btn ${i===0?'active':''}`; btn.innerText = d.day;
        btn.onclick = () => { document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderDay(i); };
        bar.appendChild(btn);
    });

    renderDay(0);
</script>
</body>
</html>
